{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<style>
    .edit-post-hero {
        background: linear-gradient(135deg, #ff7043, #ff8a65);
        color: white;
        padding: 2rem 0;
        margin-bottom: 2rem;
    }
    
    .edit-form-card {
        background: white;
        border-radius: 20px;
        padding: 2rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
    }
    
    .original-post-preview {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        border: 2px solid #e9ecef;
    }
    
    .form-floating-custom {
        position: relative;
        margin-bottom: 1.5rem;
    }
    
    .form-floating-custom textarea,
    .form-floating-custom input {
        border-radius: 15px;
        border: 2px solid #e0e6ed;
        padding: 1rem;
        transition: all 0.3s ease;
    }
    
    .form-floating-custom textarea:focus,
    .form-floating-custom input:focus {
        border-color: #ff7043;
        box-shadow: 0 0 0 0.2rem rgba(255, 112, 67, 0.25);
    }
    
    .btn-update-post {
        background: linear-gradient(135deg, #ff7043, #ff8a65);
        border: none;
        border-radius: 25px;
        padding: 0.75rem 2rem;
        font-weight: 600;
        color: white;
        transition: all 0.3s ease;
    }
    
    .btn-update-post:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(255, 112, 67, 0.4);
        color: white;
    }
    
    /* Media Management Styles */
    .media-management-section {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 1.5rem;
        margin-top: 1.5rem;
    }
    
    .media-preview-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
    }
    
    .media-item-preview {
        text-align: center;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        padding: 0.5rem;
        background: white;
    }
    
    .media-item-preview img,
    .media-item-preview .video-thumbnail {
        width: 100%;
        height: 120px;
        object-fit: cover;
        border-radius: 8px;
    }
    
    .media-item-preview .video-thumbnail {
        background: #000;
    }
    
    #newMediaPreview img,
    #newMediaPreview video {
        max-width: 200px;
        max-height: 150px;
        border-radius: 8px;
        border: 2px solid #e9ecef;
    }
    
    .form-check {
        padding: 0.75rem;
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 8px;
        margin-bottom: 0.5rem;
    }
    
    .form-check-input {
        margin-top: 0.1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="edit-post-hero">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 mx-auto text-center">
                <h1 class="display-5 fw-bold mb-3">
                    <i class="bi bi-pencil-square me-2"></i>Edit Your Post
                </h1>
                <p class="lead mb-0">Make changes to your post • Keep your story updated</p>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <!-- Navigation -->
            <div class="mb-3">
                <a href="{% url 'posts:detail' post.pk %}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-1"></i> Back to Post
                </a>
                <a href="{% url 'posts:feed' %}" class="btn btn-outline-primary ms-2">
                    <i class="bi bi-house me-1"></i> Home Feed
                </a>
            </div>
            
            <!-- Original Post Preview -->
            <div class="original-post-preview">
                <h6 class="mb-3 text-muted">
                    <i class="bi bi-eye me-1"></i> Current Post
                </h6>
                <div class="d-flex">
                    <img src="{{ post.author.get_avatar_url }}" 
                         class="rounded-circle me-3" 
                         width="45" height="45" 
                         alt="@{{ post.author.username }}">
                    
                    <div class="flex-grow-1">
                        <h6 class="mb-1">{{ post.author.get_display_name }}</h6>
                        <small class="text-muted">@{{ post.author.username }} • {{ post.created_at|timesince }} ago</small>
                        
                        {% if post.content %}
                        <div class="mt-2">{{ post.content|linebreaks }}</div>
                        {% endif %}
                        
                        {% if post.location %}
                        <div class="mt-2 small text-muted">
                            <i class="bi bi-geo-alt"></i> {{ post.location }}
                        </div>
                        {% endif %}
                        
                        {% if post.media_files.exists %}
                        <div class="mt-2">
                            <small class="text-muted">
                                <i class="bi bi-image"></i> 
                                {{ post.media_files.count }} image{% if post.media_files.count != 1 %}s{% endif %} attached
                            </small>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Edit Form -->
            <div class="edit-form-card">
                <h5 class="mb-4">
                    <i class="bi bi-pencil-fill text-warning me-2"></i>
                    Edit Post
                </h5>
                
                <form method="post" enctype="multipart/form-data" id="editForm">
                    {% csrf_token %}
                    
                    <!-- Content -->
                    <div class="form-floating-custom">
                        <label for="{{ form.content.id_for_label }}" class="form-label">
                            <i class="bi bi-chat-text me-1"></i> Post Content
                        </label>
                        {{ form.content|add_class:"form-control" }}
                        <div class="form-text">{{ form.content.help_text }}</div>
                        {% for error in form.content.errors %}
                            <div class="text-danger small mt-1">{{ error }}</div>
                        {% endfor %}
                    </div>
                    
                    <!-- Character Counter -->
                    <div class="d-flex justify-content-end mb-3">
                        <span class="character-count small text-muted" id="characterCount">0/2000</span>
                    </div>
                    
                    <!-- Location -->
                    <div class="form-floating-custom">
                        <label for="{{ form.location.id_for_label }}" class="form-label">
                            <i class="bi bi-geo-alt me-1"></i> Location (Optional)
                        </label>
                        {{ form.location|add_class:"form-control" }}
                        
                        <!-- Indian Cities Datalist -->
                        <datalist id="indian-cities">
                            <option value="Mumbai, Maharashtra">
                            <option value="Delhi, Delhi">
                            <option value="Bangalore, Karnataka">
                            <option value="Chennai, Tamil Nadu">
                            <option value="Kolkata, West Bengal">
                            <option value="Hyderabad, Telangana">
                            <option value="Pune, Maharashtra">
                            <option value="Ahmedabad, Gujarat">
                            <option value="Jaipur, Rajasthan">
                            <option value="Lucknow, Uttar Pradesh">
                        </datalist>
                        
                        <div class="form-text">{{ form.location.help_text }}</div>
                        {% for error in form.location.errors %}
                            <div class="text-danger small mt-1">{{ error }}</div>
                        {% endfor %}
                    </div>
                    
                    <!-- Privacy -->
                    <div class="form-floating-custom">
                        <label for="{{ form.privacy.id_for_label }}" class="form-label">
                            <i class="bi bi-shield-lock me-1"></i> Privacy
                        </label>
                        {{ form.privacy|add_class:"form-control" }}
                        <div class="form-text">{{ form.privacy.help_text }}</div>
                        {% for error in form.privacy.errors %}
                            <div class="text-danger small mt-1">{{ error }}</div>
                        {% endfor %}
                    </div>
                    
                    <!-- Media Management Section -->
                    {% if existing_media or can_edit_media %}
                    <div class="media-management-section border-top pt-3 mt-3">
                        <h6 class="mb-3">
                            <i class="bi bi-images me-2"></i>Media Management
                        </h6>
                        
                        <!-- Current Media Display -->
                        {% if existing_media %}
                        <div class="current-media mb-3">
                            <label class="form-label">Current Media ({{ media_count }} file{{ media_count|pluralize }}):</label>
                            <div class="media-preview-grid">
                                {% for media in existing_media %}
                                <div class="media-item-preview">
                                    {% if media.media_type == 'image' %}
                                        <img src="{{ media.file.url }}" 
                                             alt="Current media" 
                                             class="img-thumbnail">
                                        <small class="text-muted d-block mt-1">
                                            <i class="bi bi-image"></i> Image
                                        </small>
                                    {% elif media.media_type == 'video' %}
                                        <video class="video-thumbnail" 
                                               controls preload="metadata">
                                            <source src="{{ media.file.url }}" type="video/mp4">
                                        </video>
                                        <small class="text-muted d-block mt-1">
                                            <i class="bi bi-play-circle"></i> Video
                                        </small>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Remove Media Option -->
                        {% if existing_media %}
                        <div class="form-floating-custom">
                            <div class="form-check">
                                {{ form.remove_media }}
                                <label class="form-check-label" for="{{ form.remove_media.id_for_label }}">
                                    <i class="bi bi-trash text-danger me-1"></i> Remove all existing media
                                </label>
                            </div>
                            <div class="form-text text-warning">
                                {{ form.remove_media.help_text }}
                            </div>
                            {% for error in form.remove_media.errors %}
                                <div class="text-danger small mt-1">{{ error }}</div>
                            {% endfor %}
                        </div>
                        {% endif %}
                        
                        <!-- Upload New Media -->
                        <div class="form-floating-custom">
                            <label for="{{ form.new_media_file.id_for_label }}" class="form-label">
                                <i class="bi bi-cloud-upload me-1"></i> 
                                {% if existing_media %}
                                    Replace with New Media
                                {% else %}
                                    Add Media
                                {% endif %}
                            </label>
                            {{ form.new_media_file|add_class:"form-control" }}
                            <div class="form-text">
                                {{ form.new_media_file.help_text }}
                                <br><small class="text-muted">Supported: Images (JPG, PNG, GIF) up to 10MB • Videos (MP4, MOV) up to 50MB</small>
                            </div>
                            {% for error in form.new_media_file.errors %}
                                <div class="text-danger small mt-1">{{ error }}</div>
                            {% endfor %}
                        </div>
                        
                        <!-- Media Preview for New Upload -->
                        <div id="newMediaPreview" class="mt-2" style="display: none;">
                            <label class="form-label">Preview:</label>
                            <div id="previewContainer"></div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Form Actions -->
                    <div class="d-flex justify-content-between align-items-center pt-3 border-top">
                        <div class="text-muted small">
                            <i class="bi bi-info-circle me-1"></i>
                            Last updated: {{ post.updated_at|date:"F j, Y \a\\t g:i A" }}
                        </div>
                        
                        <div class="d-flex gap-2">
                            <a href="{% url 'posts:detail' post.pk %}" class="btn btn-outline-secondary">
                                <i class="bi bi-x-circle"></i> Cancel
                            </a>
                            <button type="submit" class="btn-update-post" id="submitBtn">
                                <i class="bi bi-check-circle me-1"></i> Update Post
                            </button>
                        </div>
                    </div>
                    
                    <!-- Form Errors -->
                    {% if form.non_field_errors %}
                        <div class="alert alert-danger mt-3">
                            {% for error in form.non_field_errors %}
                                <div>{{ error }}</div>
                            {% endfor %}
                        </div>
                    {% endif %}
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const contentTextarea = document.getElementById('{{ form.content.id_for_label }}');
    const characterCount = document.getElementById('characterCount');
    const submitBtn = document.getElementById('submitBtn');
    const newMediaInput = document.getElementById('{{ form.new_media_file.id_for_label }}');
    const newMediaPreview = document.getElementById('newMediaPreview');
    const previewContainer = document.getElementById('previewContainer');
    const removeMediaCheckbox = document.getElementById('{{ form.remove_media.id_for_label }}');
    
    // Character counter
    function updateCharacterCount() {
        const length = contentTextarea.value.length;
        characterCount.textContent = `${length}/2000`;
        
        characterCount.className = 'character-count small text-muted';
        if (length > 1800) {
            characterCount.className = 'character-count small text-warning';
        }
        if (length > 1950) {
            characterCount.className = 'character-count small text-danger';
        }
    }
    
    // Media preview functionality
    function previewNewMedia(file) {
        previewContainer.innerHTML = '';
        
        if (file) {
            const fileType = file.type;
            const fileSize = (file.size / (1024 * 1024)).toFixed(2); // Size in MB
            
            if (fileType.startsWith('image/')) {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                img.style.maxWidth = '200px';
                img.style.maxHeight = '150px';
                img.style.borderRadius = '8px';
                img.style.border = '2px solid #e9ecef';
                previewContainer.appendChild(img);
                
                const info = document.createElement('small');
                info.className = 'text-muted d-block mt-1';
                info.innerHTML = `<i class="bi bi-image"></i> Image • ${fileSize} MB`;
                previewContainer.appendChild(info);
                
            } else if (fileType.startsWith('video/')) {
                const video = document.createElement('video');
                video.src = URL.createObjectURL(file);
                video.controls = true;
                video.style.maxWidth = '200px';
                video.style.maxHeight = '150px';
                video.style.borderRadius = '8px';
                video.style.border = '2px solid #e9ecef';
                previewContainer.appendChild(video);
                
                const info = document.createElement('small');
                info.className = 'text-muted d-block mt-1';
                info.innerHTML = `<i class="bi bi-play-circle"></i> Video • ${fileSize} MB`;
                previewContainer.appendChild(info);
            }
            
            newMediaPreview.style.display = 'block';
        } else {
            newMediaPreview.style.display = 'none';
        }
    }
    
    // Event listeners
    contentTextarea.addEventListener('input', updateCharacterCount);
    
    // New media file preview
    if (newMediaInput) {
        newMediaInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            previewNewMedia(file);
        });
    }
    
    // Remove media checkbox interaction
    if (removeMediaCheckbox) {
        removeMediaCheckbox.addEventListener('change', function() {
            if (this.checked) {
                // Clear new media input when removing existing
                if (newMediaInput) {
                    newMediaInput.value = '';
                    previewNewMedia(null);
                }
            }
        });
    }
    
    // Clear remove media checkbox when uploading new media
    if (newMediaInput && removeMediaCheckbox) {
        newMediaInput.addEventListener('change', function() {
            if (this.files.length > 0) {
                removeMediaCheckbox.checked = false;
            }
        });
    }
    
    // Form submission
    document.getElementById('editForm').addEventListener('submit', function(e) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="bi bi-arrow-repeat spinner-border spinner-border-sm me-1"></i> Updating...';
    });
    
    // Initialize
    updateCharacterCount();
    
    // Auto-focus content field
    contentTextarea.focus();
    contentTextarea.setSelectionRange(contentTextarea.value.length, contentTextarea.value.length);
});
</script>
{% endblock %}
