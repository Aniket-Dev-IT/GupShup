{% extends 'base.html' %}
{% load static %}

{% block title %}Find People - GupShup{% endblock %}

{% block extra_css %}
<style>
    .search-card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
    }
    
    .user-card {
        transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .user-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }
    
    .user-avatar {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid var(--indian-saffron);
    }
    
    .follow-btn {
        border-radius: 20px;
        font-size: 0.9rem;
        padding: 8px 20px;
    }
    
    .filter-badge {
        background: var(--primary-gradient);
        color: white;
        border: none;
        border-radius: 20px;
        padding: 8px 15px;
        margin: 5px;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .filter-badge:hover, .filter-badge.active {
        transform: scale(1.05);
        box-shadow: 0 4px 15px rgba(255, 153, 51, 0.4);
    }
    
    .btn-primary-gradient {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
        padding: 0.75rem 2rem;
        border-radius: 25px;
        font-weight: 600;
        text-decoration: none;
        display: inline-block;
        transition: all 0.3s ease;
    }
    
    .btn-primary-gradient:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        color: white;
    }
    
    .btn-secondary-gradient {
        background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
        border: none;
        color: white;
        padding: 0.75rem 2rem;
        border-radius: 25px;
        font-weight: 600;
        text-decoration: none;
        display: inline-block;
        transition: all 0.3s ease;
    }
    
    .btn-secondary-gradient:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(108, 117, 125, 0.3);
        color: white;
        text-decoration: none;
    }
    
    .find-people-hero {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: white;
        padding: 2rem 0;
        margin-bottom: 2rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="find-people-hero">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 mx-auto text-center">
                <h1 class="display-5 fw-bold mb-3">
                    <i class="bi bi-search me-2"></i>Find People
                </h1>
                <p class="lead mb-0">Connect with amazing people from all over India on GupShup</p>
            </div>
        </div>
    </div>
</div>

<div class="container mt-4">

    <!-- Search Form -->
    <div class="row justify-content-center mb-4">
        <div class="col-lg-8">
            <div class="card search-card">
                <div class="card-body">
                    <form method="GET" class="row g-3">
                        <div class="col-md-6">
                            <label for="query" class="form-label">Search by name or username:</label>
                            <input type="text" class="form-control" id="query" name="query" 
                                   value="{{ request.GET.query }}" placeholder="Enter name or @username">
                        </div>
                        <div class="col-md-3">
                            <label for="location" class="form-label">Location:</label>
                            <input type="text" class="form-control" id="location" name="location" 
                                   value="{{ request.GET.location }}" placeholder="City, State">
                        </div>
                        <div class="col-md-3">
                            <label for="interests" class="form-label">Interests:</label>
                            <input type="text" class="form-control" id="interests" name="interests" 
                                   value="{{ request.GET.interests }}" placeholder="Cricket, Bollywood...">
                        </div>
                        <div class="col-12 text-center">
                            <button type="submit" class="btn-primary-gradient me-2">
                                <i class="bi bi-search me-2"></i>Search People
                            </button>
                            <a href="{% url 'social:user_search' %}" class="btn-secondary-gradient">
                                <i class="bi bi-arrow-clockwise me-2"></i>Clear
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Filters -->
    <div class="row mb-4">
        <div class="col-12 text-center">
            <h5>Quick Filters:</h5>
            <button type="button" class="filter-badge" onclick="applyFilter('recent')">
                Recently Joined
            </button>
            <button type="button" class="filter-badge" onclick="applyFilter('active')">
                Most Active
            </button>
            <button type="button" class="filter-badge" onclick="applyFilter('suggested')">
                Suggested for You
            </button>
        </div>
    </div>

    <!-- Search Results -->
    {% if users %}
        <div class="row">
            <div class="col-12">
                <h4 class="mb-3">
                    <i class="bi bi-people-fill"></i> 
                    Found {{ users|length }} people
                    {% if request.GET.query %}for "{{ request.GET.query }}"{% endif %}
                </h4>
            </div>
        </div>

        <div class="row">
            {% for found_user in users %}
                <div class="col-lg-4 col-md-6 mb-4">
                    <div class="card user-card h-100">
                        <div class="card-body text-center">
                            <!-- Profile Picture -->
                            {% if found_user.avatar %}
                                <img src="{{ found_user.avatar.url }}" 
                                     alt="{{ found_user.get_display_name }}" class="user-avatar mb-3">
                            {% else %}
                                <div class="user-avatar bg-gradient-primary d-flex align-items-center justify-content-center mb-3 mx-auto">
                                    <i class="bi bi-person-fill fs-3 text-white"></i>
                                </div>
                            {% endif %}

                            <!-- User Info -->
                            <h5 class="card-title mb-1">
                                <a href="{% url 'social:profile' found_user.username %}" 
                                   class="text-decoration-none">
                                    {{ found_user.get_display_name }}
                                </a>
                            </h5>
                            <p class="text-muted mb-2">@{{ found_user.username }}</p>

                            <!-- Location -->
                            {% if found_user.city %}
                                <p class="text-muted mb-2">
                                    <i class="bi bi-geo-alt"></i> {{ found_user.city }}
                                </p>
                            {% endif %}

                            <!-- Bio -->
                            {% if found_user.bio %}
                                <p class="card-text small mb-3">{{ found_user.bio|truncatewords:15 }}</p>
                            {% endif %}

                            <!-- Stats -->
                            <div class="row text-center mb-3">
                                <div class="col-4">
                                    <small class="text-muted">Posts</small>
                                    <div class="fw-bold">{{ found_user.posts.count }}</div>
                                </div>
                                <div class="col-4">
                                    <small class="text-muted">Followers</small>
                                    <div class="fw-bold">{{ found_user.followers.count }}</div>
                                </div>
                                <div class="col-4">
                                    <small class="text-muted">Following</small>
                                    <div class="fw-bold">{{ found_user.following.count }}</div>
                                </div>
                            </div>

                            <!-- Action Button -->
                            {% if found_user != user %}
                                {% if found_user in user.following.all %}
                                    <button class="btn btn-outline-primary follow-btn" 
                                            onclick="toggleFollow('{{ found_user.username }}', this)">
                                        <i class="bi bi-person-check"></i> Following
                                    </button>
                                {% else %}
                                    <button class="btn btn-primary follow-btn" 
                                            onclick="toggleFollow('{{ found_user.username }}', this)">
                                        <i class="bi bi-person-plus"></i> Follow
                                    </button>
                                {% endif %}
                            {% else %}
                                <span class="text-muted small">This is you!</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% elif request.GET %}
        <!-- No results found -->
        <div class="row justify-content-center">
            <div class="col-lg-6 text-center">
                <div class="card">
                    <div class="card-body py-5">
                        <i class="bi bi-search fs-1 text-muted mb-3"></i>
                        <h4>No people found</h4>
                        <p class="text-muted">Try adjusting your search criteria or explore suggested users.</p>
                        <a href="{% url 'social:suggested_users' %}" class="btn btn-primary">
                            <i class="bi bi-people"></i> See Suggested People
                        </a>
                    </div>
                </div>
            </div>
        </div>
    {% else %}
        <!-- Initial state - show suggestions -->
        <div class="row justify-content-center">
            <div class="col-lg-6 text-center">
                <div class="card">
                    <div class="card-body py-5">
                        <i class="bi bi-people fs-1 text-primary mb-3"></i>
                        <h4>Discover Amazing People</h4>
                        <p class="text-muted">Search for friends, colleagues, or discover new connections on GupShup!</p>
                        <div class="d-grid gap-2 d-md-block">
                            <a href="{% url 'social:suggested_users' %}" class="btn btn-primary">
                                <i class="bi bi-people"></i> See Suggested People
                            </a>
                            <button type="button" class="btn-secondary-gradient" onclick="focusSearch()">
                                <i class="bi bi-search me-2"></i>Start Searching
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
</div>

<script>
// Follow/Unfollow functionality
async function toggleFollow(username, button) {
    try {
        const response = await fetch(`/social/follow/${username}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
            },
        });

        const data = await response.json();
        
        if (data.success) {
            if (data.action === 'followed') {
                button.innerHTML = '<i class="bi bi-person-check"></i> Following';
                button.className = 'btn btn-outline-primary follow-btn';
            } else {
                button.innerHTML = '<i class="bi bi-person-plus"></i> Follow';
                button.className = 'btn btn-primary follow-btn';
            }
        } else {
            alert('Error: ' + data.message);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('An error occurred. Please try again.');
    }
}

// Quick filters
function applyFilter(filter) {
    const url = new URL(window.location);
    url.searchParams.set('filter', filter);
    window.location.href = url.toString();
}

// Focus search input
function focusSearch() {
    document.getElementById('query').focus();
}

// Get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Handle active filter badges
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const activeFilter = urlParams.get('filter');
    
    if (activeFilter) {
        const filterButton = document.querySelector(`[onclick="applyFilter('${activeFilter}')"]`);
        if (filterButton) {
            filterButton.classList.add('active');
        }
    }
});
</script>
{% endblock %}